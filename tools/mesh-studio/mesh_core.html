<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh Studio // Native Core</title>
    
    <style>
        /* --- BRUTALIST THEME --- */
        :root {
            --bg: #000000;
            --sidebar: #0a0a0a;
            --border: #333333;
            --accent: #00ff9d;
            --text-main: #eeeeee;
            --text-dim: #666666;
            --font: 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); }
        
        body { background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 2px solid var(--border); display: flex; flex-direction: column; }
        .brand-header { padding: 25px; border-bottom: 2px solid var(--accent); font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; background: #000; }
        .brand-header span { color: var(--accent); }
        
        .nav-btn {
            background: transparent; border: none; border-bottom: 1px solid #1a1a1a;
            color: #888; padding: 15px 25px; text-align: left; cursor: pointer;
            font-weight: bold; transition: 0.2s; display: block; width: 100%;
        }
        .nav-btn:hover { color: #fff; padding-left: 30px; background: #111; }
        .nav-btn.active { background: #111; color: var(--accent); border-right: 4px solid var(--accent); }

        .status-panel { margin-top: auto; padding: 20px; border-top: 1px solid var(--border); background: #050505; }
        .status-row { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 5px; color: #888; }
        .status-val { color: var(--accent); font-weight: bold; }

        /* VIEWPORT */
        .viewport { flex: 1; background: var(--bg); position: relative; display: flex; flex-direction: column; }
        .view { display: none; height: 100%; padding: 30px; overflow-y: auto; flex-direction: column; }
        .view.active { display: flex; }
        
        .view-title { 
            border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 25px;
            font-size: 1.2rem; color: #fff; text-transform: uppercase; letter-spacing: 2px;
        }

        /* GRID SYSTEM */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { border: 1px solid var(--border); padding: 20px; background: #080808; }
        .stat-label { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 10px; display: block; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #fff; }

        /* CONNECT UI */
        .split-pane { display: flex; gap: 30px; height: 100%; }
        .pane { flex: 1; border: 1px solid var(--border); padding: 20px; background: #080808; display: flex; flex-direction: column; }
        .pane h3 { color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-size: 1rem; }
        
        textarea {
            width: 100%; height: 120px; background: #000; border: 1px solid #333; color: var(--accent);
            padding: 10px; font-size: 0.7rem; resize: none; margin-bottom: 10px; font-family: monospace;
        }
        .action-btn {
            width: 100%; background: #111; color: #fff; border: 1px solid var(--accent);
            padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s;
        }
        .action-btn:hover { background: var(--accent); color: #000; }
        
        .input-group { display: flex; gap: 10px; margin-top: 10px; }
        .input-group input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 10px; }

        /* BROWSER */
        .browser-shell { flex: 1; display: flex; flex-direction: column; border: 2px solid #333; height: 100%; }
        .address-bar { display: flex; padding: 10px; background: #111; border-bottom: 1px solid #333; align-items: center; }
        .protocol { color: var(--accent); font-size: 0.8rem; margin-right: 10px; }
        #mesh-url { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 8px 15px; font-family: sans-serif; }
        #act-go { margin-left: 10px; background: var(--accent); border: none; padding: 0 20px; font-weight: bold; cursor: pointer; height: 32px; }

        .browser-frame { flex: 1; background: #fff; position: relative; overflow: auto; color: #000; padding: 20px; }
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #666; text-align: center;
        }
        .ready-msg { color: var(--accent); font-weight: bold; margin-bottom: 10px; font-size: 1.2rem; }

        /* LOGS */
        .log-panel { flex: 1; border: 1px solid var(--border); background: #000; padding: 10px; overflow-y: auto; font-size: 0.8rem; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-tx { color: var(--accent); }
        .log-rx { color: #ff00ff; }
        .log-sys { color: #666; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand-header">MESH<span>_STUDIO</span></div>
        <nav>
            <button class="nav-btn active" onclick="app.view('dashboard')">DASHBOARD</button>
            <button class="nav-btn" onclick="app.view('connect')">CONNECT PEER</button>
            <button class="nav-btn" onclick="app.view('browser')">MESH BROWSER</button>
        </nav>
        <div class="status-panel">
            <div class="status-row">
                <span>STATUS</span>
                <span id="st-status" class="status-val" style="color:#666">IDLE</span>
            </div>
            <div class="status-row">
                <span>PROTOCOL</span>
                <span class="status-val">NATIVE RTC</span>
            </div>
        </div>
    </aside>

    <main class="viewport">
        
        <section id="view-dashboard" class="view active">
            <h2 class="view-title">NETWORK KERNEL</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">PACKETS SENT</span>
                    <span class="stat-val" id="val-tx">0 KB</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">PACKETS RECEIVED</span>
                    <span class="stat-val" id="val-rx">0 KB</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">LATENCY</span>
                    <span class="stat-val" style="color:var(--accent)">1ms</span>
                </div>
            </div>
            <div class="log-panel" id="sys-logs">
                <div class="log-entry log-sys">>> SYSTEM INITIALIZED (NATIVE MODE)</div>
            </div>
        </section>

        <section id="view-connect" class="view">
            <h2 class="view-title">PEER HANDSHAKE</h2>
            <div class="split-pane">
                <div class="pane">
                    <h3>A. HOST (INITIATOR)</h3>
                    <p style="color:#666; font-size:0.8rem; margin-bottom:10px;">1. Generate Offer & Send to Client</p>
                    <textarea id="host-out" readonly placeholder="Generating offer..."></textarea>
                    <button class="action-btn" onclick="app.createHost()">GENERATE OFFER</button>
                    
                    <div class="input-group">
                        <input type="text" id="host-in" placeholder="Paste Client Answer...">
                        <button class="action-btn" style="width:auto;" onclick="app.finalizeHost()">VERIFY</button>
                    </div>
                </div>

                <div class="pane">
                    <h3>B. CLIENT (JOINER)</h3>
                    <p style="color:#666; font-size:0.8rem; margin-bottom:10px;">2. Paste Host Offer & Generate Answer</p>
                    <textarea id="client-in" placeholder="Paste Host Offer..."></textarea>
                    <button class="action-btn" onclick="app.joinClient()">JOIN NETWORK</button>
                    
                    <p style="color:#666; font-size:0.8rem; margin:10px 0;">3. Copy Answer back to Host</p>
                    <textarea id="client-out" readonly placeholder="Answer will appear here..."></textarea>
                </div>
            </div>
        </section>

        <section id="view-browser" class="view">
            <h2 class="view-title">VIRTUAL ROUTER</h2>
            <div class="browser-shell">
                <div class="address-bar">
                    <span class="protocol">mesh://</span>
                    <input type="text" id="mesh-url" value="http://localhost:3000" placeholder="remote-host:port">
                    <button id="act-go" onclick="app.navigate()">GO</button>
                </div>
                <div id="browser-frame" class="browser-frame">
                    <div class="empty-state" id="browser-status">
                        <h3>WAITING FOR CONNECTION...</h3>
                        <p>Complete the handshake in the "Connect Peer" tab first.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
    const app = {
        pc: null,
        dc: null,
        config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] },
        stats: { tx: 0, rx: 0 },

        // --- VIEW MANAGEMENT ---
        view: function(id) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        },

        // --- HOST LOGIC ---
        createHost: function() {
            this.log("Creating Host Instance...", "log-sys");
            this.initPeer(true); 

            // Host creates the channel
            this.dc = this.pc.createDataChannel("mesh");
            this.setupDc(); // Bind events immediately

            this.pc.createOffer()
                .then(d => this.pc.setLocalDescription(d))
                .catch(e => this.log(e, "log-err"));
        },

        finalizeHost: function() {
            try {
                const answer = JSON.parse(atob(document.getElementById('host-in').value));
                this.pc.setRemoteDescription(answer);
                this.log("Host Connection Finalized.", "log-sys");
            } catch(e) { alert("Invalid Code"); }
        },

        // --- CLIENT LOGIC ---
        joinClient: function() {
            this.log("Joining Network...", "log-sys");
            this.initPeer(false);

            try {
                const offer = JSON.parse(atob(document.getElementById('client-in').value));
                this.pc.setRemoteDescription(offer)
                    .then(() => this.pc.createAnswer())
                    .then(d => this.pc.setLocalDescription(d))
                    .catch(e => this.log(e, "log-err"));
                
                // Client waits for Host to create channel
                this.pc.ondatachannel = e => {
                    this.dc = e.channel;
                    this.setupDc();
                };
            } catch(e) { alert("Invalid Code"); }
        },

        // --- CORE WEBRTC ---
        initPeer: function(isHost) {
            if (this.pc) this.pc.close();
            this.pc = new RTCPeerConnection(this.config);

            this.pc.onicecandidate = e => {
                if (e.candidate === null) {
                    const signal = btoa(JSON.stringify(this.pc.localDescription));
                    if (isHost) document.getElementById('host-out').value = signal;
                    else document.getElementById('client-out').value = signal;
                    this.log("Signal Generated. Ready to Copy.", "log-sys");
                }
            };

            this.pc.onconnectionstatechange = () => {
                const state = this.pc.connectionState;
                document.getElementById('st-status').innerText = state.toUpperCase();
                if (state === 'connected') {
                    document.getElementById('st-status').style.color = '#00ff9d';
                }
            };
        },

        // --- DATA CHANNEL HANDLERS ---
        setupDc: function() {
            // Critical: Wait for OPEN event before updating UI
            this.dc.onopen = () => {
                this.log(">> DATA CHANNEL OPEN & READY <<", "log-tx");
                this.enableBrowser();
            };
            this.dc.onmessage = e => this.handleData(e.data);
            this.dc.onerror = e => this.log("DC Error: " + e, "log-err");
        },

        enableBrowser: function() {
            // Force the Browser UI to update
            const statusDiv = document.getElementById('browser-status');
            statusDiv.innerHTML = `
                <h3 class="ready-msg">CONNECTED! READY TO BROWSE</h3>
                <p>Type a local URL (e.g. http://localhost:3000) above and click GO.</p>
            `;
            // Auto switch to browser tab
            this.view('browser');
        },

        // --- BROWSER LOGIC ---
        navigate: function() {
            const url = document.getElementById('mesh-url').value;
            this.log(`Requesting: ${url}`, "log-tx");
            
            if(!this.dc || this.dc.readyState !== 'open') {
                return alert("Connection not ready yet.");
            }

            this.send({ type: 'GET', url: url });
            
            document.getElementById('browser-frame').innerHTML = 
                `<div style="text-align:center; padding:50px;">Fetching from peer...</div>`;
        },

        send: function(data) {
            const json = JSON.stringify(data);
            this.dc.send(json);
            this.stats.tx += json.length;
            this.updateStats();
        },

        handleData: async function(raw) {
            this.stats.rx += raw.length;
            this.updateStats();
            
            const msg = JSON.parse(raw);

            // HOST: Proxy Request
            if (msg.type === 'GET') {
                this.log(`Proxy Request: ${msg.url}`, "log-rx");
                try {
                    // Try fetching
                    const res = await fetch(msg.url);
                    const text = await res.text();
                    this.send({ type: 'RESP', body: text });
                } catch (e) {
                    // Send error back to client browser
                    this.send({ 
                        type: 'RESP', 
                        body: `<div style="padding:20px; color:red; border:1px solid red; font-family:sans-serif;">
                                <h3>Proxy Error</h3>
                                <p><strong>Could not fetch:</strong> ${msg.url}</p>
                                <p><strong>Reason:</strong> ${e.message}</p>
                                <p><em>Tip: Ensure the local server is running and has CORS enabled.</em></p>
                               </div>` 
                    });
                }
            }
            
            // CLIENT: Render
            else if (msg.type === 'RESP') {
                this.log("Received Content.", "log-rx");
                document.getElementById('browser-frame').innerHTML = msg.body;
            }
        },

        // --- UTILS ---
        log: function(msg, type) {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('sys-logs').prepend(div);
        },

        updateStats: function() {
            document.getElementById('val-tx').innerText = (this.stats.tx / 1024).toFixed(2) + " KB";
            document.getElementById('val-rx').innerText = (this.stats.rx / 1024).toFixed(2) + " KB";
        }
    };
    </script>
</body>
</html>